var mtl_gtfsrt_map=L.map("leaflet-map").setView([45.5576,-73.7242],11.5),map=L.map("map");L.tileLayer("https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}",{attribution:'© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> <strong><a href="https://www.mapbox.com/map-feedback/" target="_blank">Improve this map</a></strong>',tileSize:512,maxZoom:18,zoomOffset:-1,id:"felixinx/ckbmbifk40jwn1ipdubgvsfy3",accessToken:"pk.eyJ1IjoiZmVsaXhpbngiLCJhIjoiY2lqYzJoMW9vMDA1dnZsa3F3cmZzcWVsciJ9.ZWBQm52vI7RFRwGuoAzwMg"}).addTo(mtl_gtfsrt_map);var posLayer=L.layerGroup().addTo(mtl_gtfsrt_map),transitLayer=L.layerGroup().addTo(mtl_gtfsrt_map);$(function(){var t,e,a,i,o;function n(t,e){var a=new Date(null);a.setSeconds(e),a.setHours(a.getHours()+1);var i=a.toLocaleTimeString();$(".ul-timestamp").append("<li>"+t+" - "+i+"</li>")}function r(t,e){$.get("geojson/"+t+".json",function(t){L.geoJSON(t,{style:function(){return{color:e}}}).addTo(transitLayer)})}console.log("Loading MTL-TRANSIT-TRACKER version 1.3.1..."),r("stm1","#00a54f"),r("stm2","#f58220"),r("stm4","#ffdc01"),r("stm5","#0072bc"),r("exo1","#f76179"),r("exo2","#a4cb92"),r("exo3","#989ec3"),r("exo4","#4fb7b4"),r("exo5","#cf5a94"),r("exo6","#f2a69a"),function(){exoTrips={};$.getJSON("https://felixinx.github.io/mtl-gtfs-rt/data/trips/exo-trains.json",function(t){exoTrips=t})}(),t=dataUrl,(e=$.get(t)).done(function(t){var e,a;t.results.forEach(function(e){var t=$.grep(exoTrips,function(t){return t.trip_id===e.trip_id},!1)[0];L.marker(L.latLng(e.lat,e.lon),{icon:icons[e.icon]}).addTo(posLayer).bindPopup(function(t,e){var a="<h3>";a+=t.agency+" ",a+=t.vehicle_id+"</h3>",a+="<b>Trip: </b>"+t.trip_id+"<br>",a+="<b>Route: </b>"+t.route_id+"<br>",null!=e&&(a+="<b>Headsign: </b>"+e.trip_headsign+"<br>",a+="<b>Train number: </b>"+e.trip_short_name+"<br>");null!=t.start_date&&(a+="<b>Start: </b>"+t.start_date+" "+t.start_time+"<br>",a+="<b>Current stop sequence: </b>"+t.current_stop_sequence+"<br>",a+="<b>Status: </b>"+t.current_status);return a}(e,t))}),e=t.results,a=new Tabulator("#new-data-table",{height:5030,data:e,layout:"fitColumns",columns:[{title:"Agency",field:"agency",width:60},{title:"Vehicle number",field:"vehicle_id",headerFilter:"input",width:100},{title:"Route",field:"route_id",headerFilter:"input",width:60},{title:"Trip",field:"trip_id",headerFilter:"input",width:110},{title:"Start time",field:"start_time",width:85},{title:"Start date",field:"start_date",width:95},{title:"Current stop sequence",field:"current_stop_sequence",width:45,widthGrow:2},{title:"Current status",field:"current_status",width:140,widthGrow:2},{title:"Latitude",field:"lat",width:90},{title:"Longitude",field:"lon",width:100},{formatter:function(){return'<i class="fas fa-map-marked-alt"></i>'},width:50,widthGrow:1,align:"center",cellClick:function(t,e){var a,i;a=e.getRow().getData().lat,i=e.getRow().getData().lon,mtl_gtfsrt_map.setView([a,i],18),$("#mainTab li:first-child a").tab("show")}}],pagination:"local",paginationSize:100,groupBy:"agency"}),$("#download-csv").click(function(){a.download("csv","data.csv"),ga("send","event","DownloadButtons","DownloadCSV")}),n("STM Bus",t.time_stm),n("exo Trains",t.time_exo)}),e.fail(function(t,e){"undefined"!=typeof Storage&&(localStorage.getItem("v2ModalDismiss")?$("#offlineModal").modal():$("#v2Modal").on("hidden.bs.modal",function(t){$("#offlineModal").modal()}))}),a=images,i=Math.floor(Math.random()*a.length),o="url(",o+=a[i].url,o+=") center center no-repeat",$(".main-bg").css("background",o),$(".main-bg").css("background-size","cover"),$(a[i].credit).appendTo(".credits"),mtl_gtfsrt_map.on("locationfound",function(t){L.marker(t.latlng).addTo(mtl_gtfsrt_map).bindPopup("You are near here!").openPopup()}),mtl_gtfsrt_map.locate({setView:!0,maxZoom:14}),$(".loading").css("display","none"),$("#leaflet-map").css("opacity","1"),"undefined"!=typeof Storage&&(localStorage.getItem("v2ModalDismiss")||($("#v2Modal").modal("show"),$("#v2Modal").on("shown.bs.modal",function(t){$(".logo").addClass("active")}))),$("#v2ModalCloseBtn, #v2ModalCloseX").on("click",function(t){"undefined"!=typeof Storage&&localStorage.setItem("v2ModalDismiss",!0)})});var icons={busSTMIcon:L.icon({iconUrl:"assets/map-bus-stm.svg",iconSize:[20,20]}),trainExoIcon:L.icon({iconUrl:" assets/map-train-exo.svg",iconSize:[20,20]})},timestampString=+new Date,dataUrl="https://v1.transittracker.ca/data/latest.json?time="+timestampString,images=[{url:"assets/images/wikimedia-30871-min.jpg",credit:"<p>Image from Wikimedia Commons by Alexcaban</p>"},{url:"assets/images/wikimedia-amt1356-min.jpg",credit:"<p>Image from Wikimedia Commons by Mtlfiredude</p>"}];
