var mtl_gtfsrt_map=L.map("leaflet-map").setView([45.5576,-73.7242],11.5);L.tileLayer("https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}",{attribution:'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',maxZoom:18,id:"mapbox.streets",accessToken:"pk.eyJ1IjoiZmVsaXhpbngiLCJhIjoiY2lqYzJoMW9vMDA1dnZsa3F3cmZzcWVsciJ9.ZWBQm52vI7RFRwGuoAzwMg"}).addTo(mtl_gtfsrt_map);var posLayer=L.layerGroup().addTo(mtl_gtfsrt_map);var transitLayer=L.layerGroup().addTo(mtl_gtfsrt_map);$(function(){console.log("Loading MTL-TRANSIT-TRACKER version 1.3.0...");a("stm1","#00a54f");a("stm2","#f58220");a("stm4","#ffdc01");a("stm5","#0072bc");a("exo1","#f76179");a("exo2","#a4cb92");a("exo3","#989ec3");a("exo4","#4fb7b4");a("exo5","#cf5a94");a("exo6","#f2a69a");h();d(dataUrl);e(images);mtl_gtfsrt_map.on("locationfound",g);mtl_gtfsrt_map.locate({setView:true,maxZoom:14});$(".loading").css("display","none");$("#leaflet-map").css("opacity","1");if(typeof(Storage)!=="undefined"){if(!localStorage.getItem("v2ModalDismiss")){$("#v2Modal").modal("show");$("#v2Modal").on("shown.bs.modal",function(j){$(".logo").addClass("active")})}}$("#v2ModalCloseBtn, #v2ModalCloseX").on("click",function(j){if(typeof(Storage)!=="undefined"){localStorage.setItem("v2ModalDismiss",true)}});function c(j,k){mtl_gtfsrt_map.setView([j,k],18);$("#mainTab li:first-child a").tab("show")}function b(m,l){var j=new Date(null);j.setSeconds(l);j.setHours(j.getHours()+1);var k=j.toLocaleTimeString();$(".ul-timestamp").append("<li>"+m+" - "+k+"</li>")}function d(j){var k=$.get(j);k.done(function(l){l.results.forEach(function(n){var m=$.grep(exoTrips,function(o){return o.trip_id===n.trip_id},false)[0];L.marker(L.latLng(n.lat,n.lon),{icon:icons[n.icon]}).addTo(posLayer).bindPopup(i(n,m))});f(l);b("STM Bus",l.time_stm);b("exo Trains",l.time_exo)});k.fail(function(l,m){if(typeof(Storage)!=="undefined"){if(!localStorage.getItem("v2ModalDismiss")){$("#v2Modal").on("hidden.bs.modal",function(n){$("#offlineModal").modal()})}else{$("#offlineModal").modal()}}})}function a(j,k){$.get("geojson/"+j+".json",function(l){L.geoJSON(l,{style:function(){return{color:k}}}).addTo(transitLayer)})}function e(k){var j=Math.floor(Math.random()*k.length);var l="url(";l+=k[j].url;l+=") center center no-repeat";$(".main-bg").css("background",l);$(".main-bg").css("background-size","cover");$(k[j].credit).appendTo(".credits")}function f(m){var l=function(){return'<i class="fas fa-map-marked-alt"></i>'};var k=m.results;var j=new Tabulator("#new-data-table",{height:5030,data:k,layout:"fitColumns",columns:[{title:"Agency",field:"agency",width:60},{title:"Vehicle number",field:"vehicle_id",headerFilter:"input",width:100},{title:"Route",field:"route_id",headerFilter:"input",width:60},{title:"Trip",field:"trip_id",headerFilter:"input",width:110},{title:"Start time",field:"start_time",width:85},{title:"Start date",field:"start_date",width:95},{title:"Current stop sequence",field:"current_stop_sequence",width:45,widthGrow:2},{title:"Current status",field:"current_status",width:140,widthGrow:2},{title:"Latitude",field:"lat",width:90},{title:"Longitude",field:"lon",width:100},{formatter:l,width:50,widthGrow:1,align:"center",cellClick:function(o,n){c(n.getRow().getData().lat,n.getRow().getData().lon)}}],pagination:"local",paginationSize:100,groupBy:"agency"});$("#download-csv").click(function(){j.download("csv","data.csv");ga("send","event","DownloadButtons","DownloadCSV")})}function h(){exoTrips={};var j="https://felixinx.github.io/mtl-gtfs-rt/data/trips/exo-trains.json";$.getJSON(j,function(k){exoTrips=k})}function i(l,j){var k="<h3>";k+=l.agency+" ";k+=l.vehicle_id+"</h3>";k+="<b>Trip: </b>"+l.trip_id+"<br>";k+="<b>Route: </b>"+l.route_id+"<br>";if(j!=null){k+="<b>Headsign: </b>"+j.trip_headsign+"<br>";k+="<b>Train number: </b>"+j.trip_short_name+"<br>"}if(l.start_date!=null){k+="<b>Start: </b>"+l.start_date+" "+l.start_time+"<br>";k+="<b>Current stop sequence: </b>"+l.current_stop_sequence+"<br>";k+="<b>Status: </b>"+l.current_status}return k}function g(j){L.marker(j.latlng).addTo(mtl_gtfsrt_map).bindPopup("You are near here!").openPopup()}});var icons={busSTMIcon:L.icon({iconUrl:"assets/map-bus-stm.svg",iconSize:[20,20]}),trainExoIcon:L.icon({iconUrl:" assets/map-train-exo.svg",iconSize:[20,20]})};var timestampString=+new Date();var dataUrl="https://v1.transittracker.ca/data/latest.json?time="+timestampString;var images=[{url:"assets/images/wikimedia-30871-min.jpg",credit:"<p>Image from Wikimedia Commons by Alexcaban</p>"},{url:"assets/images/wikimedia-amt1356-min.jpg",credit:"<p>Image from Wikimedia Commons by Mtlfiredude</p>"}];